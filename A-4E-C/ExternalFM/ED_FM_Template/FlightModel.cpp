#include <vector>
#include <stdio.h>
#include "FlightModel.h"

//Tables
#define d_CLalpha {-0.62,-0.5928517500538861,-0.5660791877592576,-0.5395544195308914,-0.5131495517835641,-0.4867366909320529,-0.46018794339113445,-0.43337541557558573,-0.40617121390018374,-0.37844744477970504,-0.35007621462892685,-0.3209296298626259,-0.2908797968955789,-0.259798822142563,-0.22755881201835487,-0.19403187293773153,-0.15909011131546966,-0.12260563356634634,-0.08445054610513847,-0.044496955346622735,-0.0026169677055762203,0.04119967194635908,0.08638032399918036,0.13217214114110723,0.17782227991095478,0.22278779717082892,0.2672088287186069,0.3113642275627153,0.3555328467115799,0.39994062849282874,0.4444420230354891,0.4887323305580038,0.5325062453530804,0.5754632471452121,0.6176034117430811,0.6594006538551404,0.7013705878485711,0.7440288280905538,0.7878065099300791,0.8305906170374103,0.8678442105408427,0.8995257832412065,0.9220131966103622,0.93505579613183,0.9377491001927524,0.9207828508139589,0.892670221664186,0.8725675263873536,0.859073069331463,0.8494088225403229,0.8425732404268798,0.8387145839745844,0.8379554257752192,0.8381122238506523,0.8343606481837633,0.8215058269004676,0.7914216068212226,0.7339336645349858,0.6388257382637248,0.49588156622941126}
#define d_CDalpha {1.5,0.949092356575,0.555425325175,0.292578924413,0.134133172902,0.0536680892537,0.0247636920822,0.021,0.0247636920822,0.0536680892537,0.134133172902,0.292578924413,0.555425325175,0.949092356575,1.5 }
#define d_CDmach {0.0,0.0,0.0,0.0,0.0,0.000940909090909,0.0197590909091,0.0216283084005,0.0199712313003,0.0183141542002,0.0166570771001,0.015 }
#define d_CDbeta {1.23,0.978284308116,0.731177185308,0.501113771365,0.300529206075,0.141858629225,0.0375371806043,0.0,0.0375371806043,0.141858629225,0.300529206075,0.501113771365,0.731177185308,0.978284308116,1.23 }
#define d_CLflap {0.28631661553454824,0.2857509041556394,0.2853916322265178,0.2852256389733677,0.2852397636223738,0.28542084539972057,0.28575572353159273,0.2862309214633061,0.28683139050370726,0.2875415936583574,0.28834711405255725,0.28923976485336234,0.2902135123491046,0.29125861756451604,0.292342277101665,0.29342283199354297,0.29446524458885504,0.29548078137556566,0.296500427264435,0.2975493247792417,0.2986062536008963,0.29962813115937725,0.3005752634492768,0.3014390371631689,0.3022270431063664,0.3029467120918878,0.30360247411489605,0.3041970318041284,0.3047331341852939,0.3052142935664973,0.3056445067821481,0.30602777824575744,0.30636811044493206,0.3066695045204409,0.306935933951171,0.30717095872581024,0.3073778205274731,0.307559519236764,0.30771500137891017,0.3078397807931175,0.30792928663952013,0.3079794297608694,0.3079865695964513,0.30794708701324286,0.3078574668438445,0.3077143003815956,0.3075141548004194,0.3072527644926286,0.30692492616067596,0.3065254855685523,0.3060527567383943,0.3055093489155972,0.30489827240836825,0.3042283623524918,0.3035163919597926,0.3027796870757043,0.30203463924886326,0.3012962379273465,0.3005793579111591,0.2998989269396981,0.29926996031728875,0.29870748788897156,0.2982271570496762,0.2978457422931618,0.2975800918385194,0.2974406233248156,0.2974247873395428,0.29752846674117617,0.29774564515629687,0.29806606877428826,0.29847890538023303,0.29897152655580966,0.29952686266050915,0.30012716958251856,0.30075468564068963,0.30139160093236855,0.3020200978137534,0.30262314962030123,0.30318614345885936,0.3036949257223256,0.30413881948029897,0.3045189613253082,0.304838994713179,0.30510239453855675,0.305311997229775,0.30547048807334454,0.30557996793533876,0.3056400689226487,0.3056497713662549,0.3056107014536308,0.30553695390942825,0.3054462929033037,0.30535731193060445,0.3052929648961998,0.30527763458654367,0.3053335548641704,0.30547031752853476,0.3056929082881489,0.306006727696964,0.3064199519687915,0.30694187990250676,0.3075816498435331,0.30834719095432267,0.3092458904379399,0.3102853812979576,0.31147536256193653,0.3128265578336506,0.3143455719701955,0.3160002388870365,0.317737149472796,0.31950175995816765,0.321229751719153,0.32285089651862753,0.3242986773242495,0.32555267211172373,0.32662317449842815,0.32752420432048324,0.32831393940372805,0.3290829599691033,0.3299215623799423,0.3309034569939132,0.3320889614890022,0.33353467136829584,0.33523458080925456,0.3371270864672473,0.33914743624401955,0.34120406569392686,0.3431792264240429,0.3449552427375287,0.34644495569805006,0.34759397388289726,0.3483498168372411,0.34866940785066414,0.34852077426297495,0.34787231736731716,0.34668209665388355,0.3448947372450463,0.34245788944092165,0.3395103894284251,0.33646445879207465,0.3337519901500673,0.33171998152438475,0.3305816950592305,0.3305331724169168,0.33131508015897887,0.33187699749429184,0.3310906143134793,0.3279669095840279,0.321784029121727,0.31184613805742584,0.29674087070528143,0.27353632865758293,0.2391044004733767,0.18968318814054302,0.12002249298745983,0.024677105286062373,0.0,-0.11310607968880441,-0.1913588781194785,-0.21629977975854464,-0.20400952738600187,-0.17677823413915383,-0.15234690046790791,-0.13381024820831336,-0.12132113335448352,-0.11503241190053068,-0.1150969398405671,-0.12166757316870491}
#define d_CLslat {0.00041694260096494795,0.002733405629083141,0.0038384076115812187,0.003910681660155332,0.0031289608865017193,0.0016719784023165633,0.0,-0.0022713065701596424,-0.004681675515762179,-0.007052373725111416,-0.009204668086511212,-0.010961582903150469,-0.012191361109297472,-0.012924984487606902,-0.01331639271297258,-0.013524630311002428,-0.013708704093252979,-0.01398564990211687,-0.01434365081345862,-0.014735224453231888,-0.015111257217383822,-0.015422635501861404,-0.015624570167677487,-0.015830017089246806,-0.0162654078040404,-0.01700977561524064,-0.018124954051609746,-0.019672776641910028,-0.021710426483849687,-0.023478963391772023,-0.022489649170284287,-0.017120087757045876,-0.008724458133673065,0.003856260736967654,0.022554522956356737,0.04280544194683089,0.06907554510832048,0.10621661302745278,0.15275212233333224,0.19673602717607253,0.23271733254902527,0.2612410622630479,0.2837825855981376,0.3025121885912115,0.31776699669135067,0.3290910507044159,0.33603021469323685,0.3392217891575611,0.34071481958975225,0.34535883025604525,0.35895615751929266,0.3549637795607583,0.27832438650338787,0.07304878573358477,0.01593547885175417,0.01593547885175417}
#define d_Cmalpha {-0.3785964243406269,-0.379201560304398,-0.3798298142306464,-0.3804826011305135,-0.3811613360151408,-0.3818674338956694,-0.3826023097832405,-0.3833673786889958,-0.38416405562407624,-0.3849937555996234,-0.3858578936267785,-0.386757884716683,-0.38769514388047793,-0.38867108612930484,-0.38968712647430503,-0.3907446799266197,-0.3918451614973904,-0.3929899861977582,-0.3941805690388646,-0.39541832503185076,-0.39670466918785807,-0.398041016518028,-0.39942878203350163,-0.4008612653459438,-0.40228289344316953,-0.4036198863949109,-0.4047984334446556,-0.4057447238358919,-0.40638494681210763,-0.40664529161679075,-0.4065358547853261,-0.406898553839063,-0.4090508148554548,-0.4143156487900599,-0.4240310300915852,-0.4395838627338156,-0.4626997767112956,-0.4993521492742275,-0.5563506071803614,-0.6379533475704406,-0.8534408479115869,-1.0689006527803038,-1.1484598021636132,-1.1975003194361444,-1.232465516537084}
#define d_Cmadot {-0.9993130309442757,-1.0018187102761391,-1.0057137412443482,-1.0109586899351304,-1.017514122434713,-1.0253406048293243,-1.0343987032051913,-1.0446489836485415,-1.0560520122456027,-1.0685683550826022,-1.0821585782457674,-1.096783247821326,-1.1124029298955054,-1.1289781905545333,-1.146469595884637,-1.1648377119720439,-1.1840431049029818,-1.2040524714147427,-1.2250244063345275,-1.2473428282151473,-1.27140452546783,-1.297606306162126,-1.3263780089078283,-1.358250017120115,-1.3937717760511161,-1.4336332032738917,-1.4799692856776496,-1.535765202640427,-1.603674886754863,-1.6830194056536476,-1.7712396054032018,-1.86566837018059,-1.9626868506773845,-2.0411573489737553,-2.0725081152125373,-2.051629767078606,-1.9928202871720833,-1.8764916624814476,-1.5999447971294505}
#define d_Cmq {-3.5094277292596345,-3.5161567596970422,-3.5231526365828003,-3.530683596512638,-3.539017876082285,-3.5484237118874686,-3.5591693405239178,-3.571522998587362,-3.585752922673529,-3.6021273493781476,-3.6209145152969455,-3.642382657025654,-3.6668000111599985,-3.69442933986108,-3.72540943096835,-3.7597561650252067,-3.7974801615505402,-3.8385954276499694,-3.8832158394602985,-3.931569116201113,-3.9838891745237586,-4.0404129917232225,-4.101398343566679,-4.167111659804254,-4.237871697448557,-4.314912123940566,-4.400245407307992,-4.496195029307437,-4.606819861954952,-4.7368814605769884,-4.89221154553636,-5.077795536462455,-5.29021819476004}
#define d_Cmde {-0.42433674491161866,-0.43360365367346587,-0.44358321449012156,-0.4541683805320369,-0.465252104969664,-0.47672734097345454,-0.4884870417138602,-0.5004241603613329,-0.5124316500863241,-0.5244024640592858,-0.5362295554506697,-0.5478058774309277,-0.5590217544751415,-0.5697379588056424,-0.5797966638913798,-0.5890397535527863,-0.5973031012480179,-0.6043628489891902,-0.6099609273584495,-0.6138388629668243,-0.6157381824253423,-0.6154079015957615,-0.6128051380678015,-0.6081172206958865,-0.6011228713333804,-0.5856775155904658,-0.5530458025153671,-0.5095060121338942,-0.46663952741682035,-0.429251669968572,-0.3991974591512412,-0.37544477220689737,-0.3566799827137331}
#define d_CLde {0.307844559886235,0.3139230198379101,0.3197154500111718,0.3252526572503578,0.33056544839980484,0.33568463030385026,0.34064100980683176,0.3454653937530864,0.35018858898695154,0.35484140235276423,0.35945464069486216,0.3640591108575824,0.36868561968526226,0.373364974022239,0.3781278747383978,0.3829572489660009,0.3877130218373679,0.39223559310386064,0.3963824229295535,0.4001718619410713,0.40371067038340475,0.4070546553345904,0.4100006703747274,0.4122649171359812,0.4135286046368574,0.4132278501058644,0.41064825679954386,0.40339364783874804,0.3873881193466855,0.36446721821468625,0.3397687181340031,0.3159940063863457,0.29458000088650843,0.27553783634235113,0.2587491400655817,0.2440955393679079}



//Set everything to zero.
//Vectors already constructor to zero vector.
Skyhawk::FlightModel::FlightModel(Input& controls, Airframe& airframe, Engine& engine):
	m_controls(controls),
	m_airframe(airframe),
	m_engine(engine),
	m_density(0.0),
	m_speedOfSound(0.0),
	m_aoa(0.0),
	m_beta(0.0),
	m_scalarVSquared(0.0),
	m_scalarV(0.0),
	m_aileronLeft(0.0),
	m_aileronRight(0.0),
	m_elevator(0.0),
	m_rudder(0.0),
	m_q(0.0),
	m_p(0.0),
	m_k(0.0),
	m_mach(0.0),
	m_aoaDot(0.0),
	m_aoaPrevious(0.0),

	//Setup tables
	CLalpha(d_CLalpha, -0.2698, 0.5255),
	dCLflap(d_CLflap, -0.05871, 0.5255),
	dCLslat(d_CLslat, -0.06933, 0.5255),
	CLde(d_CLde, 0.157982, 1.000377),

	CDalpha(d_CDalpha,-1.57, 1.57),
	CDi({0.09}, 0, 1),
	CDmach(d_CDmach,0.0, 1.8),
	CDflap({0.153}, c_flapUp, c_flapDown),
	CDspeedBrake({0.021}, 0.0, 1.0),
	CDbeta(d_CDbeta,-1.57, 1.57),
	CDde({0.12}, c_elevatorDown, c_elevatorUp),

	CYb({-1}, 0.0, 1.0),

	Clb({ -0.01 }, 0.0, 1.0),
	Clp({ -0.3 }, 0.0, 1.0),
	Clr({ 0.15 }, 0.0, 1.0),
	Cla({ 0.220, 0.037 }, 0.0, 2.0), //110
	Cldr({ 0.01 }, 0.0, 1.0),

	Cmalpha(d_Cmalpha, 0.4004, 1.0019),
	Cmde(d_Cmde, 0.2022704, 1.00216078), //x = mach
	Cmq(d_Cmq, 0.13176098, 1.0006616),
	Cmadot(d_Cmadot, 0.1618916, 0.99790229),

	Cnb({0.12}, 0.0, 1.0),
	Cnr({-0.15}, 0.0, 1.0),
	Cndr({-0.1}, 0.0, 1.0),
	Cnda({0.0}, 0.0, 1.0)
{

}

Skyhawk::FlightModel::~FlightModel()
{

}

void Skyhawk::FlightModel::coldInit()
{

}

void Skyhawk::FlightModel::hotInit()
{

}

void Skyhawk::FlightModel::airbornInit()
{

}

//This calculates only aerodynamic forces and moments.
void Skyhawk::FlightModel::calculateAero()
{

	lift();
	drag();
	sideForce();
	thrustForce();

	L_stab();
	M_stab();
	N_stab();
	//printf("moment.z: %lf, beta: %lf, m_q: %lf, m_p: %lf, omegax: %lf, omegay: %lf, Cla(mach): %lf\n", 
		//m_moment.z, m_beta, m_q, m_p, m_omega.x, m_omega.y, Cla(m_mach));
}

//This calculates all forces and moments. Including landing gear.
void Skyhawk::FlightModel::calculateForcesAndMoments(double dt)
{
	//Reset at the start of the frame.
	m_force = Vec3();
	m_moment = Vec3();

	m_aoaDot = (m_aoa - m_aoaPrevious) / dt;

	//Get airspeed and scalar speed squared.
	m_airspeed = m_worldVelocity - m_wind;
	m_scalarVSquared = m_airspeed.x * m_airspeed.x + m_airspeed.y * m_airspeed.y + m_airspeed.z * m_airspeed.z;

	m_scalarV = sqrt(m_scalarVSquared);
	m_mach = m_scalarV / m_speedOfSound;

	m_k = m_scalarVSquared * m_density * 0.5 * m_totalWingArea;
	m_q = m_k * m_totalWingSpan;
	m_p = sqrt(m_scalarVSquared) * m_density * 0.25 * m_totalWingArea * m_totalWingSpan * m_totalWingSpan;

	calculateAero();

	m_aoaPrevious = m_aoa;
}